#!/usr/bin/env ruby

preprocess do
  begin # blog post attributes from filename
    post_regex = %r{\A/posts/(link|note)s/(\d+)-(\d+)-(\d+)-(.+).md\z}
    @items.find_all(post_regex).each do |item|
      post_type, year, month, day, slug = item.identifier.to_s.match(post_regex).captures
      item[:post_type] = post_type
      item[:date] = Time.new(year, month, day)
      item[:slug] = slug
    end
  end

  begin # assign date for drafts
    @items.find_all("/drafts/**/*").each do |item|
      item[:date] = Time.now
    end
  end if @config[:drafts]
end

# Ignore transitional Jekyll files
ignore "/_*/**/*"

# Main Index Page
compile "/index.haml" do
  filter :haml

  layout "/default.*"
  filter :typogruby

  write "/index.html"
end

# 404 Page
compile "/error.haml" do
  filter :haml

  layout "/default.*"
  filter :typogruby

  write "/404.html"
end

# KJHS 2016
compile "/resources/kjhs-2016.haml" do
  filter :haml

  layout "/default.*"
  filter :typogruby

  write "/resources/kjhs/2016/index.html"
end

# Blog Posts
compile "/posts/**/*.md" do
  filter :erb
  filter :kramdown
  filter :colorize_syntax, default_colorizer: :rouge

  layout "/post.*"
  filter :typogruby

  category      = @item[:category].downcase
  yyyy, mm, dd  = [@item[:date].year, @item[:date].month, @item[:date].day]
  slug          = @item[:slug]

  write "/#{category}/#{yyyy}/#{mm}/#{dd}/#{slug}/index.html"
end

if @config[:drafts]
  compile "/drafts/**/*" do
    filter :erb
    filter :kramdown
    filter :colorize_syntax, default_colorizer: :rouge

    layout "/post.*"
    filter :typogruby

    write item.identifier.without_ext + "/index.html"
  end
else
  ignore "/drafts/**/*"
end

compile "/atom.xml" do
  filter :erb
  write item.identifier
end

# Stylesheets
ignore '/**/_*.scss'
ignore '/**/_*.scss', rep: :source_map
compile '/**/*.scss' do
  filter :sassc, syntax: :scss

  write ext: '.css'
end

# Haml
compile "/**/*.haml" do
  filter :haml

  layout "/default.*"
  filter :typogruby

  write item.identifier.without_ext + "/index.html"
end

# Markdown
compile "/**/*.md" do
  filter :erb
  filter :kramdown
  filter :colorize_syntax, default_colorizer: :rouge

  layout "/default.*"
  filter :typogruby

  write item.identifier.without_ext + "/index.html"
end

# Catch-all
compile "/**/*" do
  write item.identifier.to_s
end

layout "/**/*", :erb
